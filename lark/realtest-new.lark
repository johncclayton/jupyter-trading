%import common.WS
%import common.CPP_COMMENT
%import common.WS_INLINE
%import common.NEWLINE
%import common.SIGNED_NUMBER -> NUMBER

%ignore WS
%ignore WS_INLINE
%ignore CPP_COMMENT

DATA_HEADER: /Data:/
IMPORT_HEADER: /Import:/
SETTINGS_HEADER: /Settings:/
BENCHMARK_HEADER: /Benchmark:/
PARAMETERS_HEADER: /Parameters:/
STRATEGY_HEADER: /Strategy:/
TEMPLATE_HEADER: /Template:/
CHARTS_HEADER: /Charts:/
TRADES_HEADER: /Trades:/
NOTES_HEADER: /Notes:/

start: section+

section: notes_section | data_section | import_section | settings_section | benchmark_section | parameters_section | strategy_section | template_section | charts_section | trades_section

notes_section: NOTES_HEADER NEWLINE? notes_content
notes_content: | /[^\n]+/

data_section: DATA_HEADER NEWLINE? declaration*
import_section: IMPORT_HEADER NEWLINE? declaration*
settings_section: SETTINGS_HEADER NEWLINE? declaration*
benchmark_section: BENCHMARK_HEADER NEWLINE? declaration*
parameters_section: PARAMETERS_HEADER NEWLINE? declaration*
strategy_section: STRATEGY_HEADER NEWLINE? declaration*
template_section: TEMPLATE_HEADER NEWLINE? declaration*
charts_section: CHARTS_HEADER NEWLINE? declaration*
trades_section: TRADES_HEADER NEWLINE? declaration*

date_expr: date_literal | "Latest" | "Earliest"
date_identifier: /(?i)StartDate/ | /(?i)EndDate/
include_list_expr: string_literal | field_list | path_name
include_name: / \{ "[^"]*" \} /
aliased_item: (identifier | stock_symbol | symbol_item) ">" identifier
field_item: aliased_item | identifier | stock_symbol | string_literal | symbol_item
declaration: date_declaration | include_list_declaration | normal_declaration
date_declaration: date_identifier ":" _TAB? date_expr NEWLINE?
include_list_declaration: /(?i)IncludeList:/ _TAB? include_list_expr include_name? NEWLINE?
normal_declaration: identifier ":" _TAB? expression NEWLINE?
expression: logical_expr format_spec? CPP_COMMENT?
format_spec: /\{%[^}]*\}/
logical_expr: comparison_expr (logical_op comparison_expr)*
logical_op: "and" | "or"
comparison_expr: add_expr (comparison_op add_expr)*
add_expr: mul_expr (add_op mul_expr)*
mul_expr: indexed_expr (mul_op indexed_expr)*
mul_op: "*" | "/"
add_op: "+" | "-"
indexed_expr: primary ("[" NUMBER "]")?
primary: "(" expression ")" | base_expr
base_expr: function_call | identifier | NUMBER | boolean_literal | stock_symbol | string_literal | field_list | path_name  
date_literal: /\d{8}|\d{4}\/\d{2}\/\d{2}|\d{4}-\d{2}-\d{2}|\d{4}\.\d{2}\.\d{2}|\d{2}-[A-Za-z]{3}-\d{2,4}|\d{1,2}\/\d{1,2}\/\d{2,4}|\d{1,2}-\d{1,2}-\d{2,4}|\d{1,2}\.\d{1,2}\.\d{2,4}/
boolean_literal: /(?i)True/ | /(?i)False/
path_name: reserved_word path_literal? | path_literal
reserved_word: /\?[a-z]+\?/
path_literal: /[^?\n]+/
field_list: field_item? ("," field_item? )*
symbol_item: /[%$][\w.]+/
comparison_op: "<" | ">" | "<=" | ">=" | "==" | "<>" | "!=" | "=" 
function_call: identifier "(" arguments? ")"
arguments: expression ("," expression)*
identifier: /(?i)(?!Data\b|Import\b|Settings\b|Benchmark\b|Parameters\b|Strategy\b|Template\b|Charts\b|Trades\b|Notes\b|True\b|False\b)[a-zA-Z_][a-zA-Z0-9_]*/
string_literal: /\${1,2}\w+/
stock_symbol: /\${1,2}[A-Z_][A-Z0-9_]*/

_TAB: /\t/
